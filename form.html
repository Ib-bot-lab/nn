<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Dynamic Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Appwrite SDK -->
  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>

  <style>
    body {
      margin: 0;
      background: #1a1a1a;
      font-family: Arial, sans-serif;
      color: #fff;
      display: flex;
      justify-content: center;
      padding: 30px;
    }

    .card {
      width: 100%;
      max-width: 500px;
      background: #2a2a2a;
      border-radius: 16px;
      padding: 24px;
      border: 1px solid #9c7c5c33;
      box-shadow: 0 10px 30px rgba(0,0,0,.4);
    }

    h1 {
      color: #e0c9b7;
      text-align: center;
      margin-bottom: 20px;
    }

    .field {
      margin-bottom: 18px;
      width: 100%;
    }

    label {
      display: block;
      font-size: 14px;
      color: #e0c9b7;
      margin-bottom: 6px;
    }

    input {
      width: 95%;
      padding: 12px;
      border-radius: 12px;
      background: #1f1f1f;
      border: 1px solid #9c7c5c55;
      color: #fff;
      outline: none;
      font-size: 15px;
    }

    input:focus {
      border-color: #9c7c5c;
    }

    button {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #9c7c5c;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(156,124,92,.5);
    }

    button:disabled {
      opacity: .6;
      cursor: not-allowed;
    }

    .status {
      text-align: center;
      margin-top: 20px;
      color: #b8a189;
    }

    .error {
      color: #ff6b6b;
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<div class="card">
  <h1 id="title">Loading...</h1>
  <form id="form"></form>
  <div id="status" class="status"></div>
  <div id="error" class="error"></div>
</div>

<script>
  const client = new Appwrite.Client()
    .setEndpoint("https://cloud.appwrite.io/v1")
    .setProject("682ed327001560d520bd");

  const databases = new Appwrite.Databases(client);

  const DATABASE_ID = "682ed34900397eda467b";
  const FORMS = "68a8d69300088396583c";
  const FIELDS = "68a8d7200033178bccd7";
  const ENTRIES = "68a8d798000a5a256402";
  const ENTRY_DATA = "68a8d7f900388407cb33";

  const formEl = document.getElementById("form");
  const titleEl = document.getElementById("title");
  const statusEl = document.getElementById("status");
  const errorEl = document.getElementById("error");

//   const formId = location.pathname.split("/").pop();
  const formId = new URLSearchParams(location.search).get("formId");;
  console.log(formId);
  
  const formData = {};

  async function loadForm() {
    try {
      statusEl.textContent = "Loading form...";
      
      const form = await databases.getDocument(
        DATABASE_ID,
        FORMS,
        formId
      );

      titleEl.textContent = form.title;

      const fieldsRes = await databases.listDocuments(
        DATABASE_ID,
        FIELDS,
        [Appwrite.Query.equal("formId", form.$id)]
      );

      formEl.innerHTML = "";

      fieldsRes.documents.forEach(field => {
        if (!["text", "number", "email", "date"].includes(field.type)) return;

        const wrapper = document.createElement("div");
        wrapper.className = "field";

        const label = document.createElement("label");
        label.textContent = field.label;

        const input = document.createElement("input");
        input.type = field.type;
        input.oninput = e => formData[field.$id] = e.target.value;

        wrapper.appendChild(label);
        wrapper.appendChild(input);
        formEl.appendChild(wrapper);
      });

      const btn = document.createElement("button");
      btn.textContent = "Submit";
      btn.type = "submit";
      formEl.appendChild(btn);

      statusEl.textContent = "";

      formEl.onsubmit = async e => {
        e.preventDefault();
        btn.disabled = true;
        statusEl.textContent = "Submitting...";

        const entry = await databases.createDocument(
          DATABASE_ID,
          ENTRIES,
          Appwrite.ID.unique(),
          { formId: form.$id, timestamp: new Date().toISOString() }
        );

        await Promise.all(
          Object.entries(formData).map(([fieldId, value]) =>
            databases.createDocument(
              DATABASE_ID,
              ENTRY_DATA,
              Appwrite.ID.unique(),
              {
                formId: form.$id,
                entryId: entry.$id,
                fieldId,
                value
              }
            )
          )
        );

        statusEl.textContent = "Submitted successfully âœ…";
        formEl.reset();
        btn.disabled = false;
      };

    } catch (err) {
      console.error(err);
      errorEl.textContent = "Failed to load form.";
    }
  }

  loadForm();
</script>

</body>
</html>
